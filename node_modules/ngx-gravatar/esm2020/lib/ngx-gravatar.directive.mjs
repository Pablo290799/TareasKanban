/* eslint-disable @angular-eslint/directive-selector */
import { Directive, Input, } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "./ngx-gravatar.service";
export class NgxGravatarDirective {
    constructor(elementRef, renderer, gravatarService) {
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.gravatarService = gravatarService;
        this.style = {};
        this.initialized = false;
        this.defaultConfig = this.gravatarService.getDefaultConfig();
        // Listen for error when fetching custom src
        this.renderer.listen(this.elementRef.nativeElement, 'error', (event) => {
            if (!this.isGravatarUsed) {
                this.initializeAvatar(true); // Force using gravatar
            }
        });
    }
    ngOnInit() {
        this.initializeAvatar();
        this.initialized = true;
        this.isGravatarUsed = false;
    }
    ngOnChanges() {
        if (this.initialized) {
            this.initializeAvatar();
        }
    }
    /**
     * Set default values for user inputs if they are not provided
     */
    setDefaultValues() {
        this.size = this.computeSize();
        this.ratio =
            this.ratio === undefined ? this.defaultConfig.ratio : this.ratio;
        this.requestedSize = this.size * this.ratio;
        this.round =
            this.round === undefined ? this.defaultConfig.round : this.round;
        this.cornerRadius =
            this.cornerRadius === undefined
                ? this.defaultConfig.cornerRadius
                : this.cornerRadius;
        this.preferGravatar =
            this.preferGravatar === undefined
                ? this.defaultConfig.preferGravatar
                : this.preferGravatar;
    }
    /**
     * Initialize avatar.
     * Custom source has higher priority if preferGravatar is not set on.
     * Finally, set styles for the avatar.
     */
    initializeAvatar(forcedGravatar) {
        this.setDefaultValues();
        let url = '';
        if (this.preferGravatar || forcedGravatar) {
            url = this.gravatarService.generateGravatarUrl(this.email, this.md5Hash, this.requestedSize, this.rating, this.fallback);
            this.isGravatarUsed = true;
        }
        else {
            // this.preferGravatar == false
            if (this.src) {
                url = this.src;
            }
            else {
                // fallback to gravatar
                url = this.gravatarService.generateGravatarUrl(this.email, this.md5Hash, this.requestedSize, this.rating, this.fallback);
                this.isGravatarUsed = true;
            }
        }
        this.renderer.setProperty(this.elementRef.nativeElement, 'src', url);
        this.setStyle(this.avatarStyle());
    }
    /**
     * Compute the size of the avatar
     *
     * @return size
     */
    computeSize() {
        let size = this.size === undefined ? this.defaultConfig.size : this.size;
        if (this.style && this.style.width) {
            try {
                const width = this.style.width.trim();
                if (width.match(/^\d+px$/)) {
                    // width with px unit
                    size = width.replace('px', '');
                }
            }
            catch (e) {
                return size;
            }
        }
        return size;
    }
    /**
     * Compute style object
     *
     * @return style object
     */
    avatarStyle() {
        const style = {
            width: this.size + 'px',
            height: this.size + 'px',
            borderRadius: this.round
                ? this.defaultConfig.borderRadius
                : this.cornerRadius + 'px',
            borderStyle: this.defaultConfig.hasBorder || this.borderColor || this.borderWidth
                ? this.defaultConfig.borderStyle
                : 'none',
            borderColor: this.borderColor
                ? this.borderColor
                : this.defaultConfig.borderColor,
            borderWidth: this.borderWidth
                ? this.borderWidth + 'px'
                : this.defaultConfig.borderWidth + 'px',
            backgroundColor: this.backgroundColor
                ? this.backgroundColor
                : this.defaultConfig.backgroundColor,
        };
        return { ...style, ...this.style };
    }
    /**
     * Set style for the avatar
     *
     * @param styles style object
     */
    setStyle(styles) {
        Object.keys(styles).forEach((key) => {
            this.renderer.setStyle(this.elementRef.nativeElement, key, styles[key]);
        });
    }
}
NgxGravatarDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.6", ngImport: i0, type: NgxGravatarDirective, deps: [{ token: i0.ElementRef }, { token: i0.Renderer2 }, { token: i1.NgxGravatarService }], target: i0.ɵɵFactoryTarget.Directive });
NgxGravatarDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.2.6", type: NgxGravatarDirective, selector: "[ngx-gravatar], [ngxGravatar]", inputs: { src: "src", email: "email", md5Hash: "md5Hash", size: "size", fallback: "fallback", rating: "rating", round: "round", cornerRadius: "cornerRadius", borderColor: "borderColor", borderWidth: "borderWidth", style: "style", preferGravatar: "preferGravatar", backgroundColor: "backgroundColor", ratio: "ratio" }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.6", ngImport: i0, type: NgxGravatarDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[ngx-gravatar], [ngxGravatar]',
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.Renderer2 }, { type: i1.NgxGravatarService }]; }, propDecorators: { src: [{
                type: Input
            }], email: [{
                type: Input
            }], md5Hash: [{
                type: Input
            }], size: [{
                type: Input
            }], fallback: [{
                type: Input
            }], rating: [{
                type: Input
            }], round: [{
                type: Input
            }], cornerRadius: [{
                type: Input
            }], borderColor: [{
                type: Input
            }], borderWidth: [{
                type: Input
            }], style: [{
                type: Input
            }], preferGravatar: [{
                type: Input
            }], backgroundColor: [{
                type: Input
            }], ratio: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWdyYXZhdGFyLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1ncmF2YXRhci9zcmMvbGliL25neC1ncmF2YXRhci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsdURBQXVEO0FBQ3ZELE9BQU8sRUFDTCxTQUFTLEVBRVQsS0FBSyxHQUlOLE1BQU0sZUFBZSxDQUFDOzs7QUFPdkIsTUFBTSxPQUFPLG9CQUFvQjtJQXFCL0IsWUFDVSxVQUFzQixFQUN0QixRQUFtQixFQUNuQixlQUFtQztRQUZuQyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsb0JBQWUsR0FBZixlQUFlLENBQW9CO1FBYnBDLFVBQUssR0FBUSxFQUFFLENBQUM7UUFldkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFDekIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDN0QsNENBQTRDO1FBQzVDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ3JFLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUN4QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyx1QkFBdUI7YUFDckQ7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxXQUFX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QkFDdEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZTtTQUN2QyxDQUFDO1FBQ0YsT0FBTyxFQUFFLEdBQUcsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssUUFBUSxDQUFDLE1BQVc7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDMUUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOztpSEFwS1Usb0JBQW9CO3FHQUFwQixvQkFBb0I7MkZBQXBCLG9CQUFvQjtrQkFIaEMsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsK0JBQStCO2lCQUMxQzswSkFFVSxHQUFHO3NCQUFYLEtBQUs7Z0JBQ0csS0FBSztzQkFBYixLQUFLO2dCQUNHLE9BQU87c0JBQWYsS0FBSztnQkFDRyxJQUFJO3NCQUFaLEtBQUs7Z0JBQ0csUUFBUTtzQkFBaEIsS0FBSztnQkFDRyxNQUFNO3NCQUFkLEtBQUs7Z0JBQ0csS0FBSztzQkFBYixLQUFLO2dCQUNHLFlBQVk7c0JBQXBCLEtBQUs7Z0JBQ0csV0FBVztzQkFBbkIsS0FBSztnQkFDRyxXQUFXO3NCQUFuQixLQUFLO2dCQUNHLEtBQUs7c0JBQWIsS0FBSztnQkFDRyxjQUFjO3NCQUF0QixLQUFLO2dCQUNHLGVBQWU7c0JBQXZCLEtBQUs7Z0JBQ0csS0FBSztzQkFBYixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1zZWxlY3RvciAqL1xuaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkluaXQsXG4gIFJlbmRlcmVyMixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOZ3hHcmF2YXRhclNlcnZpY2UgfSBmcm9tICcuL25neC1ncmF2YXRhci5zZXJ2aWNlJztcbmltcG9ydCB7IEdyYXZhdGFyQ29uZmlnIH0gZnJvbSAnLi9ncmF2YXRhci1jb25maWcnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbbmd4LWdyYXZhdGFyXSwgW25neEdyYXZhdGFyXScsXG59KVxuZXhwb3J0IGNsYXNzIE5neEdyYXZhdGFyRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkluaXQge1xuICBASW5wdXQoKSBzcmM6IHN0cmluZztcbiAgQElucHV0KCkgZW1haWw6IHN0cmluZztcbiAgQElucHV0KCkgbWQ1SGFzaDogc3RyaW5nO1xuICBASW5wdXQoKSBzaXplOiBudW1iZXI7XG4gIEBJbnB1dCgpIGZhbGxiYWNrOiBzdHJpbmc7IC8vIGVudW06IFsnYmxhbmsnLCAnaWRlbnRpY29uJywgJ21tJywgJ21vbnN0ZXJpZCcsICdyZXRybycsICdyb2JvaGFzaCcsICd3YXZhdGFyJ11cbiAgQElucHV0KCkgcmF0aW5nOiBzdHJpbmc7IC8vIGVudW06IFsnZycsICdwZycsICdyJywgJ3gnXVxuICBASW5wdXQoKSByb3VuZDogYm9vbGVhbjtcbiAgQElucHV0KCkgY29ybmVyUmFkaXVzOiBudW1iZXI7XG4gIEBJbnB1dCgpIGJvcmRlckNvbG9yOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGJvcmRlcldpZHRoOiBudW1iZXI7XG4gIEBJbnB1dCgpIHN0eWxlOiBhbnkgPSB7fTtcbiAgQElucHV0KCkgcHJlZmVyR3JhdmF0YXI6IGJvb2xlYW47XG4gIEBJbnB1dCgpIGJhY2tncm91bmRDb2xvcjogc3RyaW5nO1xuICBASW5wdXQoKSByYXRpbzogbnVtYmVyO1xuXG4gIGluaXRpYWxpemVkOiBib29sZWFuO1xuICBkZWZhdWx0Q29uZmlnOiBHcmF2YXRhckNvbmZpZztcbiAgcmVxdWVzdGVkU2l6ZTogbnVtYmVyO1xuICBpc0dyYXZhdGFyVXNlZDogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgZ3JhdmF0YXJTZXJ2aWNlOiBOZ3hHcmF2YXRhclNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5pbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIHRoaXMuZGVmYXVsdENvbmZpZyA9IHRoaXMuZ3JhdmF0YXJTZXJ2aWNlLmdldERlZmF1bHRDb25maWcoKTtcbiAgICAvLyBMaXN0ZW4gZm9yIGVycm9yIHdoZW4gZmV0Y2hpbmcgY3VzdG9tIHNyY1xuICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnZXJyb3InLCAoZXZlbnQpID0+IHtcbiAgICAgIGlmICghdGhpcy5pc0dyYXZhdGFyVXNlZCkge1xuICAgICAgICB0aGlzLmluaXRpYWxpemVBdmF0YXIodHJ1ZSk7IC8vIEZvcmNlIHVzaW5nIGdyYXZhdGFyXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmluaXRpYWxpemVBdmF0YXIoKTtcbiAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICB0aGlzLmlzR3JhdmF0YXJVc2VkID0gZmFsc2U7XG4gIH1cblxuICBuZ09uQ2hhbmdlcygpIHtcbiAgICBpZiAodGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgdGhpcy5pbml0aWFsaXplQXZhdGFyKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCBkZWZhdWx0IHZhbHVlcyBmb3IgdXNlciBpbnB1dHMgaWYgdGhleSBhcmUgbm90IHByb3ZpZGVkXG4gICAqL1xuICBwcml2YXRlIHNldERlZmF1bHRWYWx1ZXMoKTogdm9pZCB7XG4gICAgdGhpcy5zaXplID0gdGhpcy5jb21wdXRlU2l6ZSgpO1xuICAgIHRoaXMucmF0aW8gPVxuICAgICAgdGhpcy5yYXRpbyA9PT0gdW5kZWZpbmVkID8gdGhpcy5kZWZhdWx0Q29uZmlnLnJhdGlvIDogdGhpcy5yYXRpbztcbiAgICB0aGlzLnJlcXVlc3RlZFNpemUgPSB0aGlzLnNpemUgKiB0aGlzLnJhdGlvO1xuICAgIHRoaXMucm91bmQgPVxuICAgICAgdGhpcy5yb3VuZCA9PT0gdW5kZWZpbmVkID8gdGhpcy5kZWZhdWx0Q29uZmlnLnJvdW5kIDogdGhpcy5yb3VuZDtcbiAgICB0aGlzLmNvcm5lclJhZGl1cyA9XG4gICAgICB0aGlzLmNvcm5lclJhZGl1cyA9PT0gdW5kZWZpbmVkXG4gICAgICAgID8gdGhpcy5kZWZhdWx0Q29uZmlnLmNvcm5lclJhZGl1c1xuICAgICAgICA6IHRoaXMuY29ybmVyUmFkaXVzO1xuICAgIHRoaXMucHJlZmVyR3JhdmF0YXIgPVxuICAgICAgdGhpcy5wcmVmZXJHcmF2YXRhciA9PT0gdW5kZWZpbmVkXG4gICAgICAgID8gdGhpcy5kZWZhdWx0Q29uZmlnLnByZWZlckdyYXZhdGFyXG4gICAgICAgIDogdGhpcy5wcmVmZXJHcmF2YXRhcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIGF2YXRhci5cbiAgICogQ3VzdG9tIHNvdXJjZSBoYXMgaGlnaGVyIHByaW9yaXR5IGlmIHByZWZlckdyYXZhdGFyIGlzIG5vdCBzZXQgb24uXG4gICAqIEZpbmFsbHksIHNldCBzdHlsZXMgZm9yIHRoZSBhdmF0YXIuXG4gICAqL1xuICBwcml2YXRlIGluaXRpYWxpemVBdmF0YXIoZm9yY2VkR3JhdmF0YXI/OiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5zZXREZWZhdWx0VmFsdWVzKCk7XG4gICAgbGV0IHVybCA9ICcnO1xuICAgIGlmICh0aGlzLnByZWZlckdyYXZhdGFyIHx8IGZvcmNlZEdyYXZhdGFyKSB7XG4gICAgICB1cmwgPSB0aGlzLmdyYXZhdGFyU2VydmljZS5nZW5lcmF0ZUdyYXZhdGFyVXJsKFxuICAgICAgICB0aGlzLmVtYWlsLFxuICAgICAgICB0aGlzLm1kNUhhc2gsXG4gICAgICAgIHRoaXMucmVxdWVzdGVkU2l6ZSxcbiAgICAgICAgdGhpcy5yYXRpbmcsXG4gICAgICAgIHRoaXMuZmFsbGJhY2tcbiAgICAgICk7XG4gICAgICB0aGlzLmlzR3JhdmF0YXJVc2VkID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gdGhpcy5wcmVmZXJHcmF2YXRhciA9PSBmYWxzZVxuICAgICAgaWYgKHRoaXMuc3JjKSB7XG4gICAgICAgIHVybCA9IHRoaXMuc3JjO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gZmFsbGJhY2sgdG8gZ3JhdmF0YXJcbiAgICAgICAgdXJsID0gdGhpcy5ncmF2YXRhclNlcnZpY2UuZ2VuZXJhdGVHcmF2YXRhclVybChcbiAgICAgICAgICB0aGlzLmVtYWlsLFxuICAgICAgICAgIHRoaXMubWQ1SGFzaCxcbiAgICAgICAgICB0aGlzLnJlcXVlc3RlZFNpemUsXG4gICAgICAgICAgdGhpcy5yYXRpbmcsXG4gICAgICAgICAgdGhpcy5mYWxsYmFja1xuICAgICAgICApO1xuICAgICAgICB0aGlzLmlzR3JhdmF0YXJVc2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ3NyYycsIHVybCk7XG4gICAgdGhpcy5zZXRTdHlsZSh0aGlzLmF2YXRhclN0eWxlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbXB1dGUgdGhlIHNpemUgb2YgdGhlIGF2YXRhclxuICAgKlxuICAgKiBAcmV0dXJuIHNpemVcbiAgICovXG4gIHByaXZhdGUgY29tcHV0ZVNpemUoKTogbnVtYmVyIHtcbiAgICBsZXQgc2l6ZSA9IHRoaXMuc2l6ZSA9PT0gdW5kZWZpbmVkID8gdGhpcy5kZWZhdWx0Q29uZmlnLnNpemUgOiB0aGlzLnNpemU7XG4gICAgaWYgKHRoaXMuc3R5bGUgJiYgdGhpcy5zdHlsZS53aWR0aCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3Qgd2lkdGggPSB0aGlzLnN0eWxlLndpZHRoLnRyaW0oKTtcbiAgICAgICAgaWYgKHdpZHRoLm1hdGNoKC9eXFxkK3B4JC8pKSB7XG4gICAgICAgICAgLy8gd2lkdGggd2l0aCBweCB1bml0XG4gICAgICAgICAgc2l6ZSA9IHdpZHRoLnJlcGxhY2UoJ3B4JywgJycpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiBzaXplO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2l6ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wdXRlIHN0eWxlIG9iamVjdFxuICAgKlxuICAgKiBAcmV0dXJuIHN0eWxlIG9iamVjdFxuICAgKi9cbiAgcHJpdmF0ZSBhdmF0YXJTdHlsZSgpIHtcbiAgICBjb25zdCBzdHlsZSA9IHtcbiAgICAgIHdpZHRoOiB0aGlzLnNpemUgKyAncHgnLFxuICAgICAgaGVpZ2h0OiB0aGlzLnNpemUgKyAncHgnLFxuICAgICAgYm9yZGVyUmFkaXVzOiB0aGlzLnJvdW5kXG4gICAgICAgID8gdGhpcy5kZWZhdWx0Q29uZmlnLmJvcmRlclJhZGl1c1xuICAgICAgICA6IHRoaXMuY29ybmVyUmFkaXVzICsgJ3B4JyxcbiAgICAgIGJvcmRlclN0eWxlOlxuICAgICAgICB0aGlzLmRlZmF1bHRDb25maWcuaGFzQm9yZGVyIHx8IHRoaXMuYm9yZGVyQ29sb3IgfHwgdGhpcy5ib3JkZXJXaWR0aFxuICAgICAgICAgID8gdGhpcy5kZWZhdWx0Q29uZmlnLmJvcmRlclN0eWxlXG4gICAgICAgICAgOiAnbm9uZScsXG4gICAgICBib3JkZXJDb2xvcjogdGhpcy5ib3JkZXJDb2xvclxuICAgICAgICA/IHRoaXMuYm9yZGVyQ29sb3JcbiAgICAgICAgOiB0aGlzLmRlZmF1bHRDb25maWcuYm9yZGVyQ29sb3IsXG4gICAgICBib3JkZXJXaWR0aDogdGhpcy5ib3JkZXJXaWR0aFxuICAgICAgICA/IHRoaXMuYm9yZGVyV2lkdGggKyAncHgnXG4gICAgICAgIDogdGhpcy5kZWZhdWx0Q29uZmlnLmJvcmRlcldpZHRoICsgJ3B4JyxcbiAgICAgIGJhY2tncm91bmRDb2xvcjogdGhpcy5iYWNrZ3JvdW5kQ29sb3JcbiAgICAgICAgPyB0aGlzLmJhY2tncm91bmRDb2xvclxuICAgICAgICA6IHRoaXMuZGVmYXVsdENvbmZpZy5iYWNrZ3JvdW5kQ29sb3IsXG4gICAgfTtcbiAgICByZXR1cm4geyAuLi5zdHlsZSwgLi4udGhpcy5zdHlsZSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBzdHlsZSBmb3IgdGhlIGF2YXRhclxuICAgKlxuICAgKiBAcGFyYW0gc3R5bGVzIHN0eWxlIG9iamVjdFxuICAgKi9cbiAgcHJpdmF0ZSBzZXRTdHlsZShzdHlsZXM6IGFueSkge1xuICAgIE9iamVjdC5rZXlzKHN0eWxlcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCBrZXksIHN0eWxlc1trZXldKTtcbiAgICB9KTtcbiAgfVxufVxuIl19